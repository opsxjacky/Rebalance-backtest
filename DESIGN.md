# Rebalance-Backtest è®¾è®¡æ–‡æ¡£

## 1. é¡¹ç›®æ¦‚è¿°

### 1.1 é¡¹ç›®èƒŒæ™¯
Rebalance-Backtest æ˜¯ä¸€ä¸ªæŠ•èµ„ç»„åˆå†å¹³è¡¡ç­–ç•¥å›æµ‹ç³»ç»Ÿï¼Œç”¨äºè¯„ä¼°å’ŒéªŒè¯ä¸åŒå†å¹³è¡¡ç­–ç•¥åœ¨å†å²æ•°æ®ä¸Šçš„è¡¨ç°ã€‚

### 1.2 æ ¸å¿ƒç›®æ ‡
- æ”¯æŒå¤šç§å†å¹³è¡¡ç­–ç•¥çš„å®šä¹‰å’Œå›æµ‹
- æä¾›é«˜æ€§èƒ½çš„å›æµ‹å¼•æ“ï¼Œæ”¯æŒå¤§è§„æ¨¡å†å²æ•°æ®å¤„ç†
- ç”Ÿæˆè¯¦ç»†çš„ç­–ç•¥è¡¨ç°åˆ†ææŠ¥å‘Šå’Œå¯è§†åŒ–å›¾è¡¨

### 1.3 æŠ€æœ¯æ ˆé€‰æ‹©
| ç»„ä»¶ | æŠ€æœ¯ | ç”¨é€” |
|------|------|------|
| å›æµ‹å¼•æ“ | Go | é«˜æ€§èƒ½æ ¸å¿ƒè®¡ç®—ã€å¹¶å‘å¤„ç† |
| æ•°æ®åˆ†æ | Python | æ•°æ®å¤„ç†ã€ç»Ÿè®¡åˆ†æã€å¯è§†åŒ– |
| æ•°æ®å­˜å‚¨ | SQLite/PostgreSQL | æŒä¹…åŒ–å­˜å‚¨å†å²æ•°æ®å’Œå›æµ‹ç»“æœ |
| é…ç½®ç®¡ç† | YAML/JSON | ç­–ç•¥é…ç½®å’Œç³»ç»Ÿå‚æ•° |

---

## 2. ç³»ç»Ÿæ¶æ„

### 2.1 æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ç”¨æˆ·æ¥å£å±‚                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   CLI å·¥å…·    â”‚  â”‚  é…ç½®æ–‡ä»¶     â”‚  â”‚  Python API æ¥å£     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Go æ ¸å¿ƒå¼•æ“å±‚                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  æ•°æ®åŠ è½½å™¨   â”‚  â”‚  ç­–ç•¥æ‰§è¡Œå™¨   â”‚  â”‚     å›æµ‹å¼•æ“         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  äº¤æ˜“æ¨¡æ‹Ÿå™¨   â”‚  â”‚  æˆæœ¬è®¡ç®—å™¨   â”‚  â”‚     ç»“æœæ”¶é›†å™¨       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Python åˆ†æå±‚                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  æ€§èƒ½æŒ‡æ ‡è®¡ç®—  â”‚  â”‚  é£é™©åˆ†æ     â”‚  â”‚     å¯è§†åŒ–æŠ¥å‘Š       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       æ•°æ®å±‚                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  å¸‚åœºæ•°æ®     â”‚  â”‚  å›æµ‹ç»“æœ     â”‚  â”‚     ç­–ç•¥é…ç½®         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 Go ä¸ Python äº¤äº’æ–¹å¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         JSON/CSV           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶   â”‚                â”‚
â”‚   Go å›æµ‹å¼•æ“   â”‚                            â”‚  Python åˆ†æ   â”‚
â”‚                â”‚  â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       é…ç½®å‚æ•°              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                                            â”‚
         â”‚              gRPC (å¯é€‰)                    â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. æ ¸å¿ƒæ¨¡å—è®¾è®¡

### 3.1 æ•°æ®æ¨¡å— (Go)

#### 3.1.1 æ•°æ®ç»“æ„å®šä¹‰

```go
// èµ„äº§ä»·æ ¼æ•°æ®
type PriceData struct {
    Symbol    string
    Timestamp time.Time
    Open      float64
    High      float64
    Low       float64
    Close     float64
    Volume    float64
    AdjClose  float64
}

// æŠ•èµ„ç»„åˆæŒä»“
type Position struct {
    Symbol   string
    Quantity float64
    AvgCost  float64
    Value    float64
}

// æŠ•èµ„ç»„åˆå¿«ç…§
type Portfolio struct {
    Timestamp   time.Time
    Cash        float64
    Positions   map[string]Position
    TotalValue  float64
}

// äº¤æ˜“è®°å½•
type Trade struct {
    Timestamp time.Time
    Symbol    string
    Side      string  // "BUY" or "SELL"
    Quantity  float64
    Price     float64
    Fee       float64
}
```

#### 3.1.2 æ•°æ®åŠ è½½å™¨æ¥å£

```go
type DataLoader interface {
    // åŠ è½½å†å²ä»·æ ¼æ•°æ®
    LoadPrices(symbols []string, start, end time.Time) (map[string][]PriceData, error)

    // è·å–å¯ç”¨æ•°æ®èŒƒå›´
    GetDataRange(symbol string) (start, end time.Time, error)

    // æ”¯æŒçš„æ•°æ®æºç±»å‹
    SourceType() string
}
```

### 3.2 ç­–ç•¥æ¨¡å— (Go)

#### 3.2.1 å†å¹³è¡¡ç­–ç•¥æ¥å£

```go
type RebalanceStrategy interface {
    // ç­–ç•¥åç§°
    Name() string

    // è®¡ç®—ç›®æ ‡æƒé‡
    TargetWeights(portfolio Portfolio, prices map[string]PriceData) map[string]float64

    // åˆ¤æ–­æ˜¯å¦éœ€è¦å†å¹³è¡¡
    ShouldRebalance(portfolio Portfolio, prices map[string]PriceData) bool

    // ç”Ÿæˆäº¤æ˜“è®¢å•
    GenerateOrders(current, target map[string]float64, portfolio Portfolio, prices map[string]PriceData) []Order
}
```

#### 3.2.2 å†…ç½®ç­–ç•¥ç±»å‹

| ç­–ç•¥ç±»å‹ | æè¿° |
|---------|------|
| `FixedWeight` | å›ºå®šæƒé‡å†å¹³è¡¡ï¼Œç»´æŒé¢„è®¾çš„èµ„äº§é…æ¯” |
| `ThresholdBased` | é˜ˆå€¼è§¦å‘å†å¹³è¡¡ï¼Œåç¦»è¶…è¿‡é˜ˆå€¼æ—¶è§¦å‘ |
| `TimeBased` | å®šæœŸå†å¹³è¡¡ï¼ŒæŒ‰å›ºå®šæ—¶é—´é—´éš”æ‰§è¡Œ |
| `VolatilityBased` | æ³¢åŠ¨ç‡é©±åŠ¨ï¼Œæ ¹æ®å¸‚åœºæ³¢åŠ¨è°ƒæ•´é¢‘ç‡ |
| `TaxAware` | ç¨åŠ¡ä¼˜åŒ–å†å¹³è¡¡ï¼Œè€ƒè™‘ç¨æ”¶å½±å“ |

#### 3.2.3 ç­–ç•¥é…ç½®ç¤ºä¾‹

```yaml
strategy:
  name: "threshold_rebalance"
  type: "ThresholdBased"
  params:
    target_weights:
      SPY: 0.60    # ç¾è‚¡60%
      TLT: 0.30    # å€ºåˆ¸30%
      GLD: 0.10    # é»„é‡‘10%
    threshold: 0.05  # åç¦»5%è§¦å‘å†å¹³è¡¡
    min_trade_value: 100  # æœ€å°äº¤æ˜“é‡‘é¢
```

### 3.3 å›æµ‹å¼•æ“ (Go)

#### 3.3.1 å¼•æ“æ ¸å¿ƒç»“æ„

```go
type BacktestEngine struct {
    config      BacktestConfig
    dataLoader  DataLoader
    strategy    RebalanceStrategy
    costModel   CostModel
    portfolio   Portfolio
    trades      []Trade
    snapshots   []PortfolioSnapshot
}

type BacktestConfig struct {
    StartDate       time.Time
    EndDate         time.Time
    InitialCapital  float64
    Symbols         []string
    RebalanceFreq   string  // "daily", "weekly", "monthly"
    Benchmark       string
}
```

#### 3.3.2 å›æµ‹æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åˆå§‹åŒ–ç»„åˆ   â”‚â”€â”€â”€â”€â–¶â”‚  åŠ è½½æ•°æ®    â”‚â”€â”€â”€â”€â–¶â”‚  æŒ‰æ—¥æœŸéå†  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                               â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ›´æ–°å¸‚åœºä»·æ ¼ â”‚â”€â”€â”€â”€â–¶â”‚ æ£€æŸ¥å†å¹³è¡¡   â”‚â”€â”€â”€â”€â–¶â”‚ æ‰§è¡Œäº¤æ˜“    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                                       â”‚
       â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ è®°å½•å¿«ç…§    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚ è¾“å‡ºç»“æœ    â”‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.4 æˆæœ¬æ¨¡å‹ (Go)

```go
type CostModel interface {
    // è®¡ç®—äº¤æ˜“æˆæœ¬
    CalculateCost(trade Trade) float64
}

type DefaultCostModel struct {
    CommissionRate float64  // ä½£é‡‘ç‡
    MinCommission  float64  // æœ€ä½ä½£é‡‘
    SlippageRate   float64  // æ»‘ç‚¹ç‡
    TaxRate        float64  // ç¨ç‡
}
```

### 3.5 åˆ†ææ¨¡å— (Python)

#### 3.5.1 æ€§èƒ½æŒ‡æ ‡

```python
class PerformanceMetrics:
    """å›æµ‹ç»“æœæ€§èƒ½æŒ‡æ ‡è®¡ç®—"""

    def calculate_returns(self, portfolio_values: pd.Series) -> dict:
        """è®¡ç®—æ”¶ç›ŠæŒ‡æ ‡"""
        return {
            'total_return': self._total_return(portfolio_values),
            'annualized_return': self._annualized_return(portfolio_values),
            'cagr': self._cagr(portfolio_values),
        }

    def calculate_risk(self, portfolio_values: pd.Series) -> dict:
        """è®¡ç®—é£é™©æŒ‡æ ‡"""
        returns = portfolio_values.pct_change().dropna()
        return {
            'volatility': returns.std() * np.sqrt(252),
            'max_drawdown': self._max_drawdown(portfolio_values),
            'var_95': np.percentile(returns, 5),
            'cvar_95': returns[returns <= np.percentile(returns, 5)].mean(),
        }

    def calculate_ratios(self, portfolio_values: pd.Series,
                         risk_free_rate: float = 0.02) -> dict:
        """è®¡ç®—é£é™©è°ƒæ•´æ”¶ç›ŠæŒ‡æ ‡"""
        returns = portfolio_values.pct_change().dropna()
        excess_returns = returns - risk_free_rate / 252
        return {
            'sharpe_ratio': excess_returns.mean() / returns.std() * np.sqrt(252),
            'sortino_ratio': self._sortino_ratio(returns, risk_free_rate),
            'calmar_ratio': self._calmar_ratio(portfolio_values),
        }
```

#### 3.5.2 å¯è§†åŒ–æŠ¥å‘Š

```python
class ReportGenerator:
    """ç”Ÿæˆå¯è§†åŒ–æŠ¥å‘Š"""

    def generate_report(self, backtest_result: dict, output_path: str):
        """ç”Ÿæˆå®Œæ•´çš„HTMLæŠ¥å‘Š"""

    def plot_equity_curve(self, portfolio_values: pd.Series):
        """ç»˜åˆ¶æƒç›Šæ›²çº¿"""

    def plot_drawdown(self, portfolio_values: pd.Series):
        """ç»˜åˆ¶å›æ’¤å›¾"""

    def plot_weights_over_time(self, weights_history: pd.DataFrame):
        """ç»˜åˆ¶æƒé‡å˜åŒ–å›¾"""

    def plot_trade_analysis(self, trades: pd.DataFrame):
        """ç»˜åˆ¶äº¤æ˜“åˆ†æå›¾"""
```

---

## 4. ç›®å½•ç»“æ„

```
Rebalance-backtest/
â”œâ”€â”€ cmd/                          # Go å‘½ä»¤è¡Œå…¥å£
â”‚   â””â”€â”€ backtest/
â”‚       â””â”€â”€ main.go
â”œâ”€â”€ internal/                     # Go å†…éƒ¨åŒ…
â”‚   â”œâ”€â”€ engine/                   # å›æµ‹å¼•æ“
â”‚   â”‚   â”œâ”€â”€ engine.go
â”‚   â”‚   â””â”€â”€ engine_test.go
â”‚   â”œâ”€â”€ strategy/                 # ç­–ç•¥å®ç°
â”‚   â”‚   â”œâ”€â”€ interface.go
â”‚   â”‚   â”œâ”€â”€ fixed_weight.go
â”‚   â”‚   â”œâ”€â”€ threshold.go
â”‚   â”‚   â””â”€â”€ time_based.go
â”‚   â”œâ”€â”€ data/                     # æ•°æ®åŠ è½½
â”‚   â”‚   â”œâ”€â”€ loader.go
â”‚   â”‚   â”œâ”€â”€ csv_loader.go
â”‚   â”‚   â””â”€â”€ api_loader.go
â”‚   â”œâ”€â”€ cost/                     # æˆæœ¬æ¨¡å‹
â”‚   â”‚   â””â”€â”€ cost_model.go
â”‚   â””â”€â”€ portfolio/                # æŠ•èµ„ç»„åˆç®¡ç†
â”‚       â””â”€â”€ portfolio.go
â”œâ”€â”€ pkg/                          # Go å…¬å…±åŒ…
â”‚   â””â”€â”€ types/                    # å…¬å…±ç±»å‹å®šä¹‰
â”‚       â””â”€â”€ types.go
â”œâ”€â”€ python/                       # Python åˆ†ææ¨¡å—
â”‚   â”œâ”€â”€ analysis/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ metrics.py            # æ€§èƒ½æŒ‡æ ‡
â”‚   â”‚   â””â”€â”€ risk.py               # é£é™©åˆ†æ
â”‚   â”œâ”€â”€ visualization/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ charts.py             # å›¾è¡¨ç”Ÿæˆ
â”‚   â”‚   â””â”€â”€ report.py             # æŠ¥å‘Šç”Ÿæˆ
â”‚   â””â”€â”€ utils/
â”‚       â”œâ”€â”€ __init__.py
â”‚       â””â”€â”€ data_loader.py        # æ•°æ®åŠ è½½å·¥å…·
â”œâ”€â”€ configs/                      # é…ç½®æ–‡ä»¶
â”‚   â”œâ”€â”€ default.yaml
â”‚   â””â”€â”€ strategies/
â”‚       â”œâ”€â”€ fixed_weight.yaml
â”‚       â””â”€â”€ threshold.yaml
â”œâ”€â”€ data/                         # æ•°æ®ç›®å½•
â”‚   â””â”€â”€ sample/
â”œâ”€â”€ output/                       # è¾“å‡ºç›®å½•
â”œâ”€â”€ tests/                        # æµ‹è¯•
â”‚   â”œâ”€â”€ go/
â”‚   â””â”€â”€ python/
â”œâ”€â”€ scripts/                      # è¾…åŠ©è„šæœ¬
â”‚   â”œâ”€â”€ run_backtest.sh
â”‚   â””â”€â”€ generate_report.py
â”œâ”€â”€ go.mod
â”œâ”€â”€ go.sum
â”œâ”€â”€ requirements.txt              # Python ä¾èµ–
â”œâ”€â”€ Makefile
â”œâ”€â”€ README.md
â””â”€â”€ DESIGN.md                     # æœ¬æ–‡æ¡£
```

---

## 5. æ¥å£è®¾è®¡

### 5.1 CLI æ¥å£

```bash
# è¿è¡Œå›æµ‹
./backtest run --config configs/default.yaml --strategy threshold

# æŸ¥çœ‹å¸®åŠ©
./backtest --help

# è¾“å‡ºå‚æ•°
./backtest run --config configs/default.yaml \
  --start 2020-01-01 \
  --end 2023-12-31 \
  --capital 100000 \
  --output output/result.json
```

### 5.2 Go ç¼–ç¨‹æ¥å£

```go
// åˆ›å»ºå›æµ‹å¼•æ“
engine := engine.New(config)

// è®¾ç½®ç­–ç•¥
engine.SetStrategy(strategy.NewThresholdBased(params))

// è¿è¡Œå›æµ‹
result, err := engine.Run()

// å¯¼å‡ºç»“æœ
engine.ExportResults("output/result.json")
```

### 5.3 Python åˆ†ææ¥å£

```python
from analysis import BacktestAnalyzer
from visualization import ReportGenerator

# åŠ è½½å›æµ‹ç»“æœ
analyzer = BacktestAnalyzer("output/result.json")

# è®¡ç®—æŒ‡æ ‡
metrics = analyzer.calculate_all_metrics()

# ç”ŸæˆæŠ¥å‘Š
generator = ReportGenerator()
generator.generate_html_report(metrics, "output/report.html")
```

---

## 6. æ€§èƒ½æŒ‡æ ‡æ¸…å•

### 6.1 æ”¶ç›ŠæŒ‡æ ‡
- æ€»æ”¶ç›Šç‡ (Total Return)
- å¹´åŒ–æ”¶ç›Šç‡ (Annualized Return)
- å¤åˆå¹´å¢é•¿ç‡ (CAGR)

### 6.2 é£é™©æŒ‡æ ‡
- æ³¢åŠ¨ç‡ (Volatility)
- æœ€å¤§å›æ’¤ (Maximum Drawdown)
- VaR (Value at Risk)
- CVaR (Conditional VaR)

### 6.3 é£é™©è°ƒæ•´æ”¶ç›Š
- å¤æ™®æ¯”ç‡ (Sharpe Ratio)
- ç´¢æè¯ºæ¯”ç‡ (Sortino Ratio)
- å¡ç›æ¯”ç‡ (Calmar Ratio)
- ä¿¡æ¯æ¯”ç‡ (Information Ratio)

### 6.4 äº¤æ˜“ç»Ÿè®¡
- äº¤æ˜“æ¬¡æ•°
- æ¢æ‰‹ç‡
- äº¤æ˜“æˆæœ¬æ€»é¢
- å¹³å‡æŒä»“æ—¶é—´

---

## 7. å¼€å‘è·¯çº¿

### Phase 1: åŸºç¡€æ¡†æ¶
- [ ] é¡¹ç›®åˆå§‹åŒ–å’Œç›®å½•ç»“æ„
- [ ] æ ¸å¿ƒæ•°æ®ç»“æ„å®šä¹‰
- [ ] CSV æ•°æ®åŠ è½½å™¨
- [ ] åŸºç¡€æŠ•èµ„ç»„åˆç®¡ç†

### Phase 2: å›æµ‹å¼•æ“
- [ ] å›æµ‹å¼•æ“æ ¸å¿ƒå®ç°
- [ ] å›ºå®šæƒé‡å†å¹³è¡¡ç­–ç•¥
- [ ] é˜ˆå€¼è§¦å‘å†å¹³è¡¡ç­–ç•¥
- [ ] äº¤æ˜“æˆæœ¬æ¨¡å‹

### Phase 3: Python åˆ†æ
- [ ] æ€§èƒ½æŒ‡æ ‡è®¡ç®—æ¨¡å—
- [ ] é£é™©åˆ†ææ¨¡å—
- [ ] å¯è§†åŒ–å›¾è¡¨
- [ ] HTML æŠ¥å‘Šç”Ÿæˆ

### Phase 4: æ‰©å±•åŠŸèƒ½
- [ ] æ›´å¤šæ•°æ®æºæ”¯æŒ (API)
- [ ] æ›´å¤šå†å¹³è¡¡ç­–ç•¥
- [ ] å‚æ•°ä¼˜åŒ–åŠŸèƒ½
- [ ] å¤šç­–ç•¥å¯¹æ¯”åˆ†æ

---

## 8. é™„å½•

### 8.1 é…ç½®æ–‡ä»¶å®Œæ•´ç¤ºä¾‹

```yaml
# configs/default.yaml
backtest:
  start_date: "2020-01-01"
  end_date: "2023-12-31"
  initial_capital: 100000
  benchmark: "SPY"

assets:
  - symbol: "SPY"
    name: "S&P 500 ETF"
  - symbol: "TLT"
    name: "20+ Year Treasury Bond ETF"
  - symbol: "GLD"
    name: "Gold ETF"

strategy:
  type: "threshold"
  params:
    target_weights:
      SPY: 0.60
      TLT: 0.30
      GLD: 0.10
    threshold: 0.05
    min_rebalance_interval: 7  # days

costs:
  commission_rate: 0.001
  min_commission: 1.0
  slippage_rate: 0.0005

output:
  format: "json"
  path: "output/"
  generate_report: true
```

### 8.2 ä¾èµ–ç‰ˆæœ¬

**Go (go.mod):**
```
go 1.21

require (
    gopkg.in/yaml.v3 v3.0.1
    github.com/spf13/cobra v1.8.0
)
```

**Python (requirements.txt):**
```
pandas>=2.0.0
numpy>=1.24.0
matplotlib>=3.7.0
plotly>=5.18.0
jinja2>=3.1.0
```

ExportBlock-824f691f-1ba2-4af5-9e6c-a52f83c805a2-Part-1 è¿™ä¸ªæ–‡ä»¶æ˜¯æˆ‘çš„æŠ•èµ„ç»„åˆæ•°æ® ä¸è¦ä¸Šä¼ åˆ°ä»£ç ä»“åº“

lets(
  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     1. åŸºç¡€å˜é‡
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  account, prop("è´¦æˆ·"),
  type, prop("èµ„äº§ç±»å‹"),
  raw_pe_rank, prop("PEç™¾åˆ†ä½"),
  pe_val, prop("PE"),
  name, prop("è‚¡ç¥¨åç§°"),
  roe, prop("ROE"),
  peg_val, prop("PEG"),
  pl_val, prop("æµ®åŠ¨ç›ˆäº"),

  /* å½’ä¸€åŒ– PEç™¾åˆ†ä½ï¼ˆç»Ÿä¸€ä¸ºæ•´æ•°æ ¼å¼ï¼Œå¦‚ 98.33ï¼‰ */
  pe_rank, if(and(not(empty(raw_pe_rank)), raw_pe_rank <= 1), raw_pe_rank * 100, raw_pe_rank),

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     2. å‰ç½®æ¡ä»¶
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  
  /* éé›ªç›ˆè´¦æˆ·ç›´æ¥è¿”å›ç©º */
  if(not(contains(account, "é›ªç›ˆ")), "",

  lets(
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       3. æ´¾ç”Ÿå˜é‡
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    
    /* èµ„äº§åˆ†ç±» */
    is_trash, and(pl_val < 0, or(empty(pe_val), roe < 5)),
    is_safe, or(type == "å€ºåˆ¸", type == "é»„é‡‘", type == "ç°é‡‘"),
    is_core, test(name, "SPY|æ ‡æ™®|S&P|QQQ|çº³æŒ‡|Nasdaq|DXJ|æ—¥ç»|Japan"),
    is_tech, test(name, "åŠå¯¼ä½“|ç§‘æŠ€|Semiconductor|SMH|AI|XLK|QTUM"),
    
    /* ä¼°å€¼åŒºé—´ */
    is_extreme_high, and(not(empty(pe_rank)), pe_rank >= 90),
    is_high, and(not(empty(pe_rank)), pe_rank >= 75),
    is_low, and(not(empty(pe_rank)), pe_rank <= 20),
    is_core_low, and(or(is_tech, is_core), not(empty(pe_rank)), pe_rank <= 50),

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       4. è¾“å‡ºé€»è¾‘
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    ifs(
      /* ç†”æ–­ï¼šåƒåœ¾è‚¡ä¼˜å…ˆæ‹¦æˆª */
      is_trash, "ğŸ”´ æé«˜ (åŸºæœ¬é¢å·®)",
      
      /* å®‰å…¨èµ„äº§ */
      is_safe, "âšªï¸ æŒ‰æƒé‡é…ç½®",
      
      /* ETF */
      type == "ETF", ifs(
        and(is_extreme_high, is_core), "ğŸŸ  åŠ¨æ€å†å¹³è¡¡ (Trim)",
        and(is_extreme_high, is_tech), "ğŸŸ  è¶‹åŠ¿æŒæœ‰ (Tech)",
        is_extreme_high, "ğŸ”´ æåº¦é«˜ä¼° (å–å‡º)",
        or(is_low, is_core_low), "ğŸŸ¢ ä½ä¼°æœºä¼š (ä¹°å…¥)",
        is_high, "ğŸŸ¡ åé«˜ (è§‚å¯Ÿ)",
        "âšªï¸ æ­£å¸¸æŒæœ‰"
      ),
      
      /* ä¸ªè‚¡ */
      type == "ä¸ªè‚¡", ifs(
        and(pe_rank >= 80, peg_val > 2.5), "ğŸ”´ æ³¡æ²«ç ´è£‚ (PEGè¿‡é«˜)",
        peg_val > 2.0, "ğŸŸ  ä¼°å€¼é€æ”¯ (å‡ä»“)",
        or(and(not(empty(peg_val)), peg_val < 1.5), roe >= 20), "ğŸŸ¢ ä¼˜è´¨æŒæœ‰",
        pe_rank >= 80, "ğŸŸ  ä¼°å€¼è¿‡é«˜ (å‡ä»“)",
        "âšªï¸ æ­£å¸¸"
      ),
      
      /* å…œåº• */
      "â“ æœªçŸ¥ç±»å‹"
    )
  ))
)

è¿™ä¸ªæ˜¯æˆ‘çš„æŠ•èµ„ç»„åˆç­–ç•¥ï¼Œå¸®æˆ‘è¿›è¡Œå›æµ‹çœ‹çœ‹ç»“æœ
mynotion æ˜¯æˆ‘çš„æŠ•èµ„ç»„åˆæ•°æ®ï¼Œè¿™ä¸ªæ•°æ®ä¸è¦ä¸Šä¼ åˆ°github
å…ˆå¸®æˆ‘å›æµ‹ä¸€ä¸‹é›ªç›ˆçš„è‚¡ç¥¨ä»£ç ï¼Œè¿™ä¸ªæ˜¯ä¼°å€¼ç­–ç•¥ï¼Œæ²¡æœ‰è®¾ç½®æƒé‡